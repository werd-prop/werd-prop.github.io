<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rocket Performance Calculator</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; padding: 16px; background: #f6f7f9; }
    .card { max-width: 820px; margin: 0 auto; background: white; border-radius: 16px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.08); }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .grid { grid-template-columns: 1fr 1fr; } }
    label { display: block; font-size: 12px; color: #444; margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid #d0d6dd; border-radius: 12px; font-size: 16px; }
    .row2 { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    .btns { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #c7cdd6; background: #fff; font-size: 15px; cursor: pointer; }
    button.primary { background: #111827; color: #fff; border-color: #111827; }
    .out { margin-top: 16px; padding: 12px; background: #f3f4f6; border-radius: 12px; }
    .mono { font-variant-numeric: tabular-nums; }
    .small { font-size: 12px; color: #555; line-height: 1.35; }
    .warn { color: #8a2a2a; }
    .table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    .table th, .table td { text-align: left; padding: 8px 6px; border-bottom: 1px solid rgba(0,0,0,.08); vertical-align: top; }
    .table th { font-size: 12px; color: #444; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#e5e7eb; font-size: 12px; }
    a { color:#0b57d0; text-decoration:none; }
    a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Rocket Performance Calculator</h1>

    <div class="grid">
      <div>
        <label for="isp">Specific impulse (Isp)</label>
        <div class="row2">
          <input id="isp" type="number" step="any" value="300" />
          <select id="ispUnit">
            <option value="s" selected>seconds (s)</option>
          </select>
        </div>
        <div class="small">Isp is in seconds in both SI/English usage.</div>
      </div>

      <!-- UPDATED g0 block: presets + unit selector + value -->
      <div>
        <label for="g0Preset">Earth Standard gravity (g₀)</label>
        <div class="row2">
          <select id="g0Preset">
            <option value="earth_si" selected>9.80665</option>
            <option value="earth_eng">32.174</option>
            <option value="custom">Custom</option>
          </select>
          <select id="gUnit">
            <option value="mps2" selected>m/s²</option>
            <option value="ftps2">ft/s²</option>
          </select>
        </div>
        <div style="height:10px"></div>
        <input id="g0" type="number" step="any" value="9.80665" />
        <div class="small">
          Used for c = Isp·g₀. Earth standard g₀ values from Appendix 1.
        </div>
      </div>

      <div>
        <label for="m0">Initial mass (m₀)</label>
        <div class="row2">
          <input id="m0" type="number" step="any" value="500" />
          <select id="m0Unit">
            <option value="kg" selected>kg</option>
            <option value="lbm">lbm</option>
          </select>
        </div>
      </div>

      <div>
        <label for="mf">Final mass / dry mass (m_f)</label>
        <div class="row2">
          <input id="mf" type="number" step="any" value="200" />
          <select id="mfUnit">
            <option value="kg" selected>kg</option>
            <option value="lbm">lbm</option>
          </select>
        </div>
      </div>

      <div>
        <label for="mdot">Mass flow rate (ṁ)</label>
        <div class="row2">
          <input id="mdot" type="number" step="any" value="2.5" />
          <select id="mdotUnit">
            <option value="kgps" selected>kg/s</option>
            <option value="lbmps">lbm/s</option>
          </select>
        </div>
        <div class="small">Leave blank to skip thrust/burn time.</div>
      </div>

      <div>
        <label for="notes">Notes (optional)</label>
        <input id="notes" type="text" placeholder="e.g., vacuum engine, sea-level test, stage 2…" />
      </div>
    </div>

    <div class="btns">
      <button class="primary" id="calcBtn">Calculate</button>
      <button id="resetBtn">Reset</button>
      <button id="shareBtn">Copy share link</button>
    </div>

    <div class="out" id="output">
      <div class="small">Enter values and tap <b>Calculate</b>.</div>
    </div>
  </div>

<script>
(function () {
  const $ = (id) => document.getElementById(id);

  // Constants
  const LBM_TO_KG = 0.45359237;
  const FT_TO_M = 0.3048;
  const N_TO_LBF = 1 / 4.4482216152605;

  // Earth standard gravity constants (Appendix 1): :contentReference[oaicite:1]{index=1}
  const G0_EARTH_SI = 9.80665;   // m/s^2
  const G0_EARTH_ENG = 32.174;   // ft/s^2

  const fmt = (x, digits = 4) => {
    if (!Number.isFinite(x)) return "—";
    const ax = Math.abs(x);
    if (ax !== 0 && (ax >= 1e6 || ax < 1e-3)) return x.toExponential(6);
    return x.toLocaleString(undefined, { maximumFractionDigits: digits });
  };

  function readNumber(id) {
    const v = $(id).value.trim();
    if (v === "") return NaN;
    const n = Number(v);
    return Number.isFinite(n) ? n : NaN;
  }

  function toSI_mass(value, unit) {
    if (!Number.isFinite(value)) return NaN;
    return unit === "lbm" ? value * LBM_TO_KG : value;
  }

  function toSI_mdot(value, unit) {
    if (!Number.isFinite(value)) return NaN;
    return unit === "lbmps" ? value * LBM_TO_KG : value;
  }

  function toSI_g0(value, unit) {
    if (!Number.isFinite(value)) return NaN;
    return unit === "ftps2" ? value * FT_TO_M : value; // ft/s^2 -> m/s^2
  }

  function setFromQuery() {
    const p = new URLSearchParams(location.search);
    const fields = ["isp","g0","m0","mf","mdot","notes","gUnit","m0Unit","mfUnit","mdotUnit","g0Preset"];
    for (const f of fields) {
      if (p.has(f)) $(f).value = p.get(f);
    }
  }

  function makeShareLink() {
    const p = new URLSearchParams();
    ["isp","g0Preset","gUnit","g0","m0Unit","m0","mfUnit","mf","mdotUnit","mdot","notes"].forEach(f => {
      const v = $(f).value.trim();
      if (v !== "") p.set(f, v);
    });
    return `${location.origin}${location.pathname}?${p.toString()}`;
  }

  // NEW: g0 preset behavior
  function syncG0PresetToValue() {
    const preset = $("g0Preset").value;

    if (preset === "earth_si") {
      $("gUnit").value = "mps2";
      $("g0").value = G0_EARTH_SI;
      $("g0").disabled = true;
      $("gUnit").disabled = true;
      return;
    }

    if (preset === "earth_eng") {
      $("gUnit").value = "ftps2";
      $("g0").value = G0_EARTH_ENG;
      $("g0").disabled = true;
      $("gUnit").disabled = true;
      return;
    }

    // custom
    $("g0").disabled = false;
    $("gUnit").disabled = false;
  }

  $("g0Preset").addEventListener("change", () => {
    syncG0PresetToValue();
  });

  function calculate() {
    const isp = readNumber("isp"); // s

    const g0_in = readNumber("g0");
    const gUnit = $("gUnit").value;

    const m0_in = readNumber("m0");
    const mf_in = readNumber("mf");
    const m0Unit = $("m0Unit").value;
    const mfUnit = $("mfUnit").value;

    const mdot_in = readNumber("mdot");
    const mdotUnit = $("mdotUnit").value;

    const notes = $("notes").value.trim();

    const problems = [];
    if (!(isp > 0)) problems.push("Isp must be > 0.");
    if (!(g0_in > 0)) problems.push("g₀ must be > 0.");
    if (!(m0_in > 0)) problems.push("m₀ must be > 0.");
    if (!(mf_in > 0)) problems.push("m_f must be > 0.");

    const g0 = toSI_g0(g0_in, gUnit);
    const m0 = toSI_mass(m0_in, m0Unit);
    const mf = toSI_mass(mf_in, mfUnit);

    // --- Echo inputs in both unit systems ---
    const g0_si = g0;                 // m/s^2
    const g0_eng = g0 / FT_TO_M;      // ft/s^2

    const m0_si = m0;                 // kg
    const m0_eng = m0 / LBM_TO_KG;    // lbm

    const mf_si = mf;                 // kg
    const mf_eng = mf / LBM_TO_KG;    // lbm

    const mdot_si = Number.isFinite(mdot) ? mdot : NaN;              // kg/s
    const mdot_eng = Number.isFinite(mdot) ? mdot / LBM_TO_KG : NaN; // lbm/s
    
    if (!(g0 > 0)) problems.push("g₀ conversion failed.");
    if (!(m0 > 0) || !(mf > 0)) problems.push("Mass conversion failed.");
    if (Number.isFinite(m0) && Number.isFinite(mf) && m0 <= mf) problems.push("m₀ must be greater than m_f (you need propellant mass).");

    let mdot = NaN;
    if (!Number.isNaN(mdot_in)) {
      if (!(mdot_in > 0)) problems.push("ṁ must be > 0 if provided.");
      mdot = toSI_mdot(mdot_in, mdotUnit);
      if (!Number.isFinite(mdot) || mdot <= 0) problems.push("ṁ conversion failed (or is non-positive).");
    }

    // Core computations (SI)
    const c = isp * g0;                    // m/s
    const MR = mf / m0; // MR = final mass / initial mass
    const PMF = 1 - MR; // propellant mass fraction = (m0 - mf)/m0  
    const dv = c * Math.log(massRatio);    // m/s
    const mp = m0 - mf;                    // kg

    let thrustN = NaN;
    let burnTime = NaN;
    if (Number.isFinite(mdot) && mdot > 0) {
      thrustN = mdot * c;      // N (ideal)
      burnTime = mp / mdot;    // s
    }

    // English outputs derived from SI
    const c_ftps = c / FT_TO_M;
    const dv_ftps = dv / FT_TO_M;
    const mp_lbm = mp / LBM_TO_KG;
    const thrustLbf = thrustN * N_TO_LBF;

    const out = [];

    out.push(`
  <div class="small"><span class="pill">Inputs (SI & English)</span></div>

  <table class="table mono">
    <thead>
      <tr>
        <th>Input</th>
        <th>SI</th>
        <th>English</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><b>Isp</b></td>
        <td colspan="2">${fmt(isp, 4)} s</td>
      </tr>
      <tr>
        <td><b>g₀</b></td>
        <td>${fmt(g0_si)} m/s²</td>
        <td>${fmt(g0_eng)} ft/s²</td>
      </tr>
      <tr>
        <td><b>m₀</b></td>
        <td>${fmt(m0_si)} kg</td>
        <td>${fmt(m0_eng)} lbm</td>
      </tr>
      <tr>
        <td><b>m_f</b></td>
        <td>${fmt(mf_si)} kg</td>
        <td>${fmt(mf_eng)} lbm</td>
      </tr>
      <tr>
        <td><b>ṁ</b></td>
        <td>${Number.isFinite(mdot_si) ? `${fmt(mdot_si)} kg/s` : "—"}</td>
        <td>${Number.isFinite(mdot_eng) ? `${fmt(mdot_eng)} lbm/s` : "—"}</td>
      </tr>
    </tbody>
  </table>
`);


    
    if (problems.length) {
      out.push(`<div class="warn"><b>Please fix:</b><ul>${problems.map(x => `<li>${x}</li>`).join("")}</ul></div>`);
    }

    out.push(`<div class="small"><span class="pill">Outputs shown in SI + English</span></div>`);

    out.push(`
      <table class="table mono">
        <thead>
          <tr>
            <th>Metric</th>
            <th>SI</th>
            <th>English</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><b>c</b> (effective exhaust velocity)</td>
            <td>${fmt(c)} m/s</td>
            <td>${fmt(c_ftps)} ft/s</td>
          </tr>
          <tr>
            <td><b>m₀/m_f</b> (mass ratio)</td>
            <td colspan="2">${fmt(massRatio, 6)} (unitless)</td>
          </tr>
          <tr>
            <td><b>PMF</b> (m<sub>p</sub> / m₀)</td>
            <td colspan="2">${fmt(PMF, 6)} (unitless)</td>
          </tr>         
          <tr>
            <td><b>Δv</b> (ideal)</td>
            <td>${fmt(dv)} m/s</td>
            <td>${fmt(dv_ftps)} ft/s</td>
          </tr>
          <tr>
            <td><b>m_p</b> (propellant mass)</td>
            <td>${fmt(mp)} kg</td>
            <td>${fmt(mp_lbm)} lbm</td>
          </tr>
          <tr>
            <td><b>T</b> (ideal thrust)</td>
            <td>${Number.isFinite(thrustN) ? `${fmt(thrustN)} N` : "—"}</td>
            <td>${Number.isFinite(thrustLbf) ? `${fmt(thrustLbf)} lbf` : "—"}</td>
          </tr>
          <tr>
            <td><b>t</b> (burn time)</td>
            <td colspan="2">${Number.isFinite(burnTime) ? `${fmt(burnTime)} s` : "—"}</td>
          </tr>
        </tbody>
      </table>
    `);

    out.push(`
      <div class="small">
        Earth standard g₀: 9.80665 m/s² = 32.174 ft/s². :contentReference[oaicite:2]{index=2}
      </div>
    `);

    if (!Number.isFinite(thrustN)) {
      out.push(`<div class="small">Provide ṁ to compute thrust and burn time.</div>`);
    }

    out.push(`<div class="small">Assumes constant Isp, constant ṁ (if provided), and ideal vacuum Δv (no drag, no gravity losses).</div>`);
    if (notes) out.push(`<div class="small"><b>Notes:</b> ${notes.replaceAll("<","&lt;").replaceAll(">","&gt;")}</div>`);

    $("output").innerHTML = out.join("");
  }

  $("calcBtn").addEventListener("click", calculate);

  $("resetBtn").addEventListener("click", () => {
    $("isp").value = 300;

    $("g0Preset").value = "earth_si";
    $("gUnit").value = "mps2";
    $("g0").value = G0_EARTH_SI;

    $("m0").value = 500;
    $("mf").value = 200;
    $("m0Unit").value = "kg";
    $("mfUnit").value = "kg";

    $("mdot").value = 2.5;
    $("mdotUnit").value = "kgps";

    $("notes").value = "";
    history.replaceState({}, "", location.pathname);
    syncG0PresetToValue();
    $("output").innerHTML = `<div class="small">Enter values and tap <b>Calculate</b>.</div>`;
  });

  $("shareBtn").addEventListener("click", async () => {
    const url = makeShareLink();
    try {
      await navigator.clipboard.writeText(url);
      $("output").innerHTML = `<div class="small">Copied share link:</div><div class="mono">${url}</div>` + $("output").innerHTML;
    } catch {
      window.prompt("Copy this link:", url);
    }
  });

  // init
  setFromQuery();
  syncG0PresetToValue();
  if (location.search.length > 1) calculate();
})();
</script>
</body>
</html>
