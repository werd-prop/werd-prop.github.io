<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rocket Performance Calculator</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; padding: 16px; background: #f6f7f9; }
    .card { max-width: 820px; margin: 0 auto; background: white; border-radius: 16px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.08); }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .grid { grid-template-columns: 1fr 1fr; } }
    label { display: block; font-size: 12px; color: #444; margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid #d0d6dd; border-radius: 12px; font-size: 16px; }
    .row2 { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    .btns { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #c7cdd6; background: #fff; font-size: 15px; cursor: pointer; }
    button.primary { background: #111827; color: #fff; border-color: #111827; }
    .out { margin-top: 16px; padding: 12px; background: #f3f4f6; border-radius: 12px; }
    .mono { font-variant-numeric: tabular-nums; }
    .small { font-size: 12px; color: #555; line-height: 1.35; }
    .warn { color: #8a2a2a; }
    .table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    .table th, .table td { text-align: left; padding: 8px 6px; border-bottom: 1px solid rgba(0,0,0,.08); vertical-align: top; }
    .table th { font-size: 12px; color: #444; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#e5e7eb; font-size: 12px; }
    a { color:#0b57d0; text-decoration:none; }
    a:hover { text-decoration:underline; }
  </style>
</head>

<body>
  <div class="card">
    <h1>Rocket Performance Calculator</h1>

    <div class="grid">
      <div>
        <label for="isp">Specific impulse (Isp)</label>
        <div class="row2">
          <input id="isp" type="number" step="any" value="300" />
          <select id="ispUnit">
            <option value="s" selected>seconds (s)</option>
          </select>
        </div>
        <div class="small">Isp is in seconds in both SI/English usage.</div>
      </div>

      <div>
        <label for="g0Preset">Earth Standard gravity (g₀)</label>
        <div class="row2">
          <select id="g0Preset">
            <option value="earth_si" selected>9.80665</option>
            <option value="earth_eng">32.174</option>
            <option value="custom">Custom</option>
          </select>
          <select id="gUnit">
            <option value="mps2" selected>m/s²</option>
            <option value="ftps2">ft/s²</option>
          </select>
        </div>
        <div style="height:10px"></div>
        <input id="g0" type="number" step="any" value="9.80665" />
        <div class="small">Used for c = Isp·g₀.</div>
      </div>

      <div>
        <label for="m0">Initial mass (m₀)</label>
        <div class="row2">
          <input id="m0" type="number" step="any" value="500" />
          <select id="m0Unit">
            <option value="kg" selected>kg</option>
            <option value="lbm">lbm</option>
          </select>
        </div>
      </div>

      <div>
        <label for="mf">Final mass / dry mass (m_f)</label>
        <div class="row2">
          <input id="mf" type="number" step="any" value="200" />
          <select id="mfUnit">
            <option value="kg" selected>kg</option>
            <option value="lbm">lbm</option>
          </select>
        </div>
      </div>

      <div>
        <label for="mdot">Mass flow rate (ṁ)</label>
        <div class="row2">
          <input id="mdot" type="number" step="any" value="2.5" />
          <select id="mdotUnit">
            <option value="kgps" selected>kg/s</option>
            <option value="lbmps">lbm/s</option>
          </select>
        </div>
        <div class="small">Leave blank to skip thrust/burn time.</div>
      </div>

      <div>
        <label for="notes">Notes (optional)</label>
        <input id="notes" type="text" placeholder="e.g., vacuum engine, sea-level test, stage 2…" />
      </div>
    </div>

    <div class="btns">
      <button class="primary" id="calcBtn">Calculate</button>
      <button id="resetBtn">Reset</button>
      <button id="shareBtn">Copy share link</button>
    </div>

    <div class="out" id="output">
      <div class="small">Enter values and tap <b>Calculate</b>.</div>
    </div>
  </div>

<script>
(() => {
  // ---------------------------
  // Helpers
  // ---------------------------
  const $ = (id) => document.getElementById(id);

  const num = (id) => {
    const raw = $(id).value.trim();
    if (raw === "") return NaN;
    const n = Number(raw);
    return Number.isFinite(n) ? n : NaN;
  };

  const esc = (s) =>
    String(s).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");

  const fmt = (x, digits = 4) => {
    if (!Number.isFinite(x)) return "—";
    const ax = Math.abs(x);
    if (ax !== 0 && (ax >= 1e6 || ax < 1e-3)) return x.toExponential(6);
    return x.toLocaleString(undefined, { maximumFractionDigits: digits });
  };

  // Small HTML builders (keeps templates readable)
  const pill = (text) => `<div class="small"><span class="pill">${text}</span></div>`;

  const table = (headCells, bodyRowsHtml) => `
    <table class="table mono">
      <thead>
        <tr>${headCells.map(h => `<th>${h}</th>`).join("")}</tr>
      </thead>
      <tbody>
        ${bodyRowsHtml}
      </tbody>
    </table>
  `;

  const row = (cells) => `<tr>${cells.map(c => `<td>${c}</td>`).join("")}</tr>`;

  // ---------------------------
  // Units / constants
  // ---------------------------
  const LBM_TO_KG = 0.45359237;
  const FT_TO_M = 0.3048;
  const N_TO_LBF = 1 / 4.4482216152605;

  // Earth standard gravity
  const G0_EARTH_SI = 9.80665; // m/s^2
  const G0_EARTH_ENG = 32.174; // ft/s^2

  const toSI = {
    mass: (value, unit) => (unit === "lbm" ? value * LBM_TO_KG : value),
    mdot: (value, unit) => (unit === "lbmps" ? value * LBM_TO_KG : value),
    g0:   (value, unit) => (unit === "ftps2" ? value * FT_TO_M : value), // ft/s^2 -> m/s^2
  };

  // ---------------------------
  // URL share/load
  // ---------------------------
  const QUERY_FIELDS = [
    "isp",
    "g0Preset", "gUnit", "g0",
    "m0Unit", "m0",
    "mfUnit", "mf",
    "mdotUnit", "mdot",
    "notes",
  ];

  function loadFromQuery() {
    const p = new URLSearchParams(location.search);
    for (const key of QUERY_FIELDS) {
      if (p.has(key)) $(key).value = p.get(key);
    }
  }

  function makeShareLink() {
    const p = new URLSearchParams();
    for (const key of QUERY_FIELDS) {
      const v = $(key).value.trim();
      if (v !== "") p.set(key, v);
    }
    return `${location.origin}${location.pathname}?${p.toString()}`;
  }

  // ---------------------------
  // g0 preset behavior
  // ---------------------------
  function applyG0Preset() {
    const preset = $("g0Preset").value;

    if (preset === "earth_si") {
      $("gUnit").value = "mps2";
      $("g0").value = G0_EARTH_SI;
      $("g0").disabled = true;
      $("gUnit").disabled = true;
      return;
    }

    if (preset === "earth_eng") {
      $("gUnit").value = "ftps2";
      $("g0").value = G0_EARTH_ENG;
      $("g0").disabled = true;
      $("gUnit").disabled = true;
      return;
    }

    // custom
    $("g0").disabled = false;
    $("gUnit").disabled = false;
  }

  $("g0Preset").addEventListener("change", applyG0Preset);

  // ---------------------------
  // Core calculation
  // ---------------------------
  function readInputs() {
    const isp = num("isp");              // seconds
    const g0_in = num("g0");
    const gUnit = $("gUnit").value;

    const m0_in = num("m0");
    const mf_in = num("mf");
    const m0Unit = $("m0Unit").value;
    const mfUnit = $("mfUnit").value;

    const mdot_in = num("mdot");         // optional
    const mdotUnit = $("mdotUnit").value;

    const notes = $("notes").value.trim();

    return { isp, g0_in, gUnit, m0_in, mf_in, m0Unit, mfUnit, mdot_in, mdotUnit, notes };
  }

  function validateAndConvert(inp) {
    const problems = [];

    if (!(inp.isp > 0)) problems.push("Isp must be > 0.");
    if (!(inp.g0_in > 0)) problems.push("g₀ must be > 0.");
    if (!(inp.m0_in > 0)) problems.push("m₀ must be > 0.");
    if (!(inp.mf_in > 0)) problems.push("m_f must be > 0.");

    const g0 = toSI.g0(inp.g0_in, inp.gUnit);
    const m0 = toSI.mass(inp.m0_in, inp.m0Unit);
    const mf = toSI.mass(inp.mf_in, inp.mfUnit);

    if (!(g0 > 0)) problems.push("g₀ conversion failed.");
    if (!(m0 > 0) || !(mf > 0)) problems.push("Mass conversion failed.");
    if (Number.isFinite(m0) && Number.isFinite(mf) && m0 <= mf) {
      problems.push("m₀ must be greater than m_f (you need propellant mass).");
    }

    // mdot optional
    let mdot = NaN;
    if (!Number.isNaN(inp.mdot_in)) {
      if (!(inp.mdot_in > 0)) problems.push("ṁ must be > 0 if provided.");
      mdot = toSI.mdot(inp.mdot_in, inp.mdotUnit);
      if (!Number.isFinite(mdot) || mdot <= 0) problems.push("ṁ conversion failed (or is non-positive).");
    }

    return { problems, si: { isp: inp.isp, g0, m0, mf, mdot }, notes: inp.notes };
  }

  function compute(si) {
    // Rocket equation (ideal vacuum)
    const c = si.isp * si.g0;           // m/s
    const massRatio = si.m0 / si.mf;    // m0/mf
    const dv = c * Math.log(massRatio); // m/s
    const mp = si.m0 - si.mf;           // kg
    const pmf = mp / si.m0;             // propellant mass fraction

    let thrustN = NaN;
    let burnTime = NaN;
    if (Number.isFinite(si.mdot) && si.mdot > 0) {
      thrustN = si.mdot * c;            // N (ideal)
      burnTime = mp / si.mdot;          // s
    }

    return { c, massRatio, dv, mp, pmf, thrustN, burnTime };
  }

  function render({ inp, si, results, problems, notes }) {
    // Input echo (SI + English)
    const g0_si = si.g0;
    const g0_eng = si.g0 / FT_TO_M;

    const m0_si = si.m0;
    const m0_eng = si.m0 / LBM_TO_KG;

    const mf_si = si.mf;
    const mf_eng = si.mf / LBM_TO_KG;

    const mdot_si = Number.isFinite(si.mdot) ? si.mdot : NaN;
    const mdot_eng = Number.isFinite(si.mdot) ? si.mdot / LBM_TO_KG : NaN;

    // Output in both systems
    const c_ftps = results.c / FT_TO_M;
    const dv_ftps = results.dv / FT_TO_M;
    const mp_lbm = results.mp / LBM_TO_KG;
    const thrustLbf = results.thrustN * N_TO_LBF;

    const parts = [];

    parts.push(pill("Inputs (SI & English)"));
    parts.push(
      table(
        ["Input", "SI", "English"],
        [
          row([`<b>Isp</b>`, `${fmt(si.isp, 4)} s`, `${fmt(si.isp, 4)} s`]),
          row([`<b>g₀</b>`, `${fmt(g0_si)} m/s²`, `${fmt(g0_eng)} ft/s²`]),
          row([`<b>m₀</b>`, `${fmt(m0_si)} kg`, `${fmt(m0_eng)} lbm`]),
          row([`<b>m_f</b>`, `${fmt(mf_si)} kg`, `${fmt(mf_eng)} lbm`]),
          row([
            `<b>ṁ</b>`,
            Number.isFinite(mdot_si) ? `${fmt(mdot_si)} kg/s` : "—",
            Number.isFinite(mdot_eng) ? `${fmt(mdot_eng)} lbm/s` : "—",
          ]),
        ].join("")
      )
    );

    if (problems.length) {
      parts.push(
        `<div class="warn"><b>Please fix:</b><ul>${problems.map(p => `<li>${esc(p)}</li>`).join("")}</ul></div>`
      );
    }

    parts.push(pill("Outputs shown in SI + English"));
    parts.push(
      table(
        ["Metric", "SI", "English"],
        [
          row([`<b>c</b> (effective exhaust velocity)`, `${fmt(results.c)} m/s`, `${fmt(c_ftps)} ft/s`]),
          row([`<b>m₀/m_f</b> (mass ratio)`, `${fmt(results.massRatio, 6)} (unitless)`, `${fmt(results.massRatio, 6)} (unitless)`]),
          row([`<b>PMF</b> (m<sub>p</sub> / m₀)`, `${fmt(results.pmf, 6)} (unitless)`, `${fmt(results.pmf, 6)} (unitless)`]),
          row([`<b>Δv</b> (ideal)`, `${fmt(results.dv)} m/s`, `${fmt(dv_ftps)} ft/s`]),
          row([`<b>m_p</b> (propellant mass)`, `${fmt(results.mp)} kg`, `${fmt(mp_lbm)} lbm`]),
          row([
            `<b>T</b> (ideal thrust)`,
            Number.isFinite(results.thrustN) ? `${fmt(results.thrustN)} N` : "—",
            Number.isFinite(results.thrustN) ? `${fmt(thrustLbf)} lbf` : "—",
          ]),
          row([
            `<b>t</b> (burn time)`,
            Number.isFinite(results.burnTime) ? `${fmt(results.burnTime)} s` : "—",
            Number.isFinite(results.burnTime) ? `${fmt(results.burnTime)} s` : "—",
          ]),
        ].join("")
      )
    );

    if (!Number.isFinite(results.thrustN)) {
      parts.push(`<div class="small">Provide ṁ to compute thrust and burn time.</div>`);
    }

    parts.push(`<div class="small">Assumes constant Isp, constant ṁ (if provided), and ideal vacuum Δv (no drag, no gravity losses).</div>`);
    if (notes) parts.push(`<div class="small"><b>Notes:</b> ${esc(notes)}</div>`);

    $("output").innerHTML = parts.join("");
  }

  function calculate() {
    const inp = readInputs();
    const { problems, si, notes } = validateAndConvert(inp);

    // If basics are invalid, still render inputs + problems, but avoid NaN cascades
    const safeToCompute =
      problems.length === 0 ||
      (si.isp > 0 && si.g0 > 0 && si.m0 > 0 && si.mf > 0 && si.m0 > si.mf);

    const results = safeToCompute ? compute(si) : {
      c: NaN, massRatio: NaN, dv: NaN, mp: NaN, pmf: NaN, thrustN: NaN, burnTime: NaN
    };

    render({ inp, si, results, problems, notes });
  }

  // ---------------------------
  // Buttons
  // ---------------------------
  $("calcBtn").addEventListener("click", calculate);

  $("resetBtn").addEventListener("click", () => {
    $("isp").value = 300;

    $("g0Preset").value = "earth_si";
    $("gUnit").value = "mps2";
    $("g0").value = G0_EARTH_SI;

    $("m0").value = 500;
    $("mf").value = 200;
    $("m0Unit").value = "kg";
    $("mfUnit").value = "kg";

    $("mdot").value = 2.5;
    $("mdotUnit").value = "kgps";

    $("notes").value = "";

    history.replaceState({}, "", location.pathname);
    applyG0Preset();
    $("output").innerHTML = `<div class="small">Enter values and tap <b>Calculate</b>.</div>`;
  });

  $("shareBtn").addEventListener("click", async () => {
    const url = makeShareLink();
    try {
      await navigator.clipboard.writeText(url);
      $("output").innerHTML =
        `<div class="small">Copied share link:</div><div class="mono">${esc(url)}</div>` +
        $("output").innerHTML;
    } catch {
      window.prompt("Copy this link:", url);
    }
  });

  // ---------------------------
  // Init
  // ---------------------------
  loadFromQuery();
  applyG0Preset();
  if (location.search.length > 1) calculate();
})();
</script>
</body>
</html>
